---
title: "Collar_depth_measure_time"
output: html_document
---

# loading necessary packages
```{r preliminaries, message=FALSE, echo=FALSE}
library(drake)  # 6.1.0
library(readxl)
library(styler)
library(ggplot2)
theme_set(theme_bw())
library(cowplot)
library(tidyr)
library(dplyr)
library(cowplot)
library(data.table)
library(lubridate)
library(kableExtra)
library(knitr)
library(ggpubr)
library(ggmap)
library(maps)
library(mapdata)
library(leaflet)
library(sp)
library(RColorBrewer)
# install.packages("patchwork")
library(patchwork)
# Source all needed functions
source('functions.R')
# set data and outputs file direction
DATA_DIR <- 'data'
OUT_DIR <- 'outputs'
# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, 
                      echo = FALSE, warning = FALSE,
                      fig.height = 4, fig.width = 8, cache = FALSE)
```

# Prepare data
## get MGRhD
```{r get MGRhD}
srdbv4 <- readd(srdbv4)
srdbv5 <- readd(srdbv5)
``` 

# Data analysis
## test whether collar depth affect Rs_annual
```{r test collar insert depth}
time_depth_test (srdbv5, Collar_height, 50)
```



```{r test collar insert depth, fig.width=6, fig.height=6}
# aggregate Rs_annual by every 5
srdbv5 %>% 
  select(Rs_annual, Collar_depth, Ecosystem_type) %>% 
  filter(Rs_annual < 5000 & Collar_depth < 20 & Ecosystem_type != "") %>% 
  mutate(Ecosystem_group = case_when(
    Ecosystem_type %in% c("Agriculture", "Orchard") ~ "Agriculture",
    Ecosystem_type == "Desert" ~ "Desert",
    Ecosystem_type %in% c("Forest", "Plantation") ~ "Forest",
    Ecosystem_type %in% c("Grassland", "Turfgrass", "Urban", "Urban lawn") ~ "Grassland",
    Ecosystem_type %in% c("Savanna", "Shrubland", "Steppe") ~ "Shrubland",
    Ecosystem_type %in% c("Tundra", "Wetland") ~ "Wetland",
    Ecosystem_type %in% c("Savanna", "Shrubland", "Steppe") ~ "Shrubland",
    TRUE ~ "None"
  )) %>% 
  group_by(Ecosystem_group, Collar_depth) %>% 
  summarise(Rs_annual = mean(Rs_annual),
            obs = n()) %>% 
  mutate(obs2 = ifelse(obs <= 100, obs, 110)) %>% 
  ggplot(aes(Collar_depth, Rs_annual)) +
  geom_point(aes(size  = obs2), shape = 16, alpha = 0.5) +
  facet_grid(rows = vars(Ecosystem_group), scales = "free") +
  geom_smooth(method = "lm", fill = "skyblue") +
  theme_set(theme_bw()) +
  labs(x="Collar depth (cm)", y = expression(R[S]~(g~C~m^{-2}~yr^{-1}))) +
  labs(size="obs (n)")

```

```{r test chamber area}
time_depth_test (srdbv5, Chamber_area, 4000)
```


```{r test measure interval}
time_depth_test (srdbv5, Meas_interval, 150)
```

```{r test time of day}
srdbv5 %>% 
  select(Rs_annual, Collar_height, Collar_depth, Chamber_area, Time_of_day, Meas_interval, Annual_coverage) %>% 
  filter(Time_of_day!="") %>% 
  count(Time_of_day) %>% 
  arrange(n)

srdbv5 %>% 
  select(Rs_annual, Collar_height, Collar_depth, Chamber_area, Time_of_day, Meas_interval, Annual_coverage) %>% 
  filter(Time_of_day!="" & !is.na(Rs_annual)) %>% 
  mutate(Time_day_group = case_when(
    Time_of_day == "0to24" ~ "Full day",
    TRUE ~ "Not full day")
    ) %>% 
  ggplot(aes(Time_day_group, Rs_annual, fill = as.factor(Time_day_group))) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) +
  # geom_jitter(shape = 16, position = position_jitter(0.2), col = "gray") +
  # geom_boxplot(width = 0.1) +
  theme(legend.title = element_blank()) +
  scale_fill_brewer(palette="Set2") +
  xlab(expression(Measure~time~group)) +
  ylab(expression(Annual~R[S])) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

```




