---
title: "Collar_depth_measure_time"
output: html_document
---

# loading necessary packages
```{r preliminaries, message=FALSE, echo=FALSE}
library(drake)  # 6.1.0
library(readxl)
library(styler)
library(ggplot2)
theme_set(theme_bw())
library(cowplot)
library(tidyr)
library(dplyr)
library(cowplot)
library(data.table)
library(lubridate)
library(kableExtra)
library(knitr)
library(ggpubr)
library(ggmap)
library(maps)
library(mapdata)
library(leaflet)
library(sp)
library(RColorBrewer)
# install.packages("patchwork")
library(patchwork)
# Source all needed functions
source('functions.R')
# set data and outputs file direction
DATA_DIR <- 'data'
OUT_DIR <- 'outputs'
# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, 
                      echo = FALSE, warning = FALSE,
                      fig.height = 4, fig.width = 8, cache = FALSE)
```

# Prepare data
## get data
```{r get MGRhD}
srdbv5 <- readd(srdbv5)
meas_time_mapping <- readd(meas_time_mapping)
``` 

## date process
```{r}
# srdbv5 %>% 
#   select(Rs_annual, Collar_height, Collar_depth, Chamber_area, Time_of_day, Meas_interval, Annual_coverage) %>% 
#   filter(Time_of_day!="") %>% 
#   count(Time_of_day) %>% 
#   arrange(n) -> meas_time_mapping
# writ_file(meas_time_mapping, 'meas_time_mapping.csv')

left_join(
  srdbv5,
  meas_time_mapping %>% 
    select(Time_of_day, start1, end1, hour_cover),
  by = "Time_of_day") -> 
  srdbv5
```

```{r SLR test}
# SLR test collar height, collar depth, collar area, measure tume, and measure interval
SLR_sum(srdbv5)
```



```{r MLR - collar depth}
# by ecosystem type
srdbv5 %>% 
  select(Rs_annual, Collar_depth, Ecosystem_type) %>% 
  filter(Rs_annual < 5000 & Collar_depth < 20 & Ecosystem_type != "") %>% 
  mutate(Ecosystem_group = case_when(
    Ecosystem_type %in% c("Agriculture", "Orchard") ~ "Agriculture",
    Ecosystem_type == "Desert" ~ "Desert",
    Ecosystem_type %in% c("Forest", "Plantation") ~ "Forest",
    Ecosystem_type %in% c("Grassland", "Turfgrass", "Urban", "Urban lawn") ~ "Grassland",
    Ecosystem_type %in% c("Savanna", "Shrubland", "Steppe") ~ "Shrubland",
    Ecosystem_type %in% c("Tundra", "Wetland") ~ "Wetland",
    Ecosystem_type %in% c("Savanna", "Shrubland", "Steppe") ~ "Shrubland",
    TRUE ~ "None")) %>% 
  group_by(Ecosystem_group, Collar_depth) %>% 
  summarise(Rs_annual = mean(Rs_annual), obs = n()) ->
  agg_srdb

lm(agg_srdb$Rs_annual ~ agg_srdb$Collar_depth * agg_srdb$Ecosystem_group, weights = agg_srdb$obs) ->
  lm_depth2
summary(lm_depth2)

# test by ecosystem_type
lm_eco_test <- function(dat, eco) {
  dat %>% 
    filter(Ecosystem_group == eco) ->
    sub_eco
  # return(sub_eco)
  lm(sub_eco$Rs_annual ~ sub_eco$Collar_depth, weights = sub_eco$obs) ->
    lm_eco
  print(summary(lm_eco))
  
  sub_eco$standardized_resids <- rstandard( lm_eco )
  sub_eco$predicted_rs <- fitted(lm_eco)
  sub_eco$cook_d <- cooks.distance( lm_eco )
  
  # plot predicted rs vs. student residue
  sub_eco %>% 
    ggplot( aes( predicted_rs, standardized_resids ))  +
    ylab( expression( Standardized~residue )) +
    xlab( expression( Fitted~R[S]~(g~C~m^{-2}~yr^{-1}))) +
    geom_point( col=alpha('black', 0.5), size = 2 ) + geom_smooth( method='lm' ) ->
    p1
  print(p1)
  
  # plot predicted rs vs. cook distance
  sub_eco %>% 
    ggplot( aes( predicted_rs, cook_d ))  +
    ylab( expression( Cook~distance )) +
    xlab( expression( Fitted~R[S]~(g~C~m^{-2}~yr^{-1}))) +
    geom_point( col=alpha('black', 0.5), size = 2 ) + geom_smooth( method='lm' ) ->
    p2
  print(p2)
  
  return(sub_eco)
}

lm_eco_test(agg_srdb, "Agriculture")
lm_eco_test(agg_srdb, "Desert")
lm_eco_test(agg_srdb, "Forest")
lm_eco_test(agg_srdb, "Grassland")
lm_eco_test(agg_srdb, "Shrubland")
lm_eco_test(agg_srdb %>% filter(Collar_depth!=10), "Shrubland")
lm_eco_test(agg_srdb, "Wetland")
```


```{r lm measure interval}
# by biome type
srdbv5 %>% 
  select(Rs_annual, Biome, Meas_interval) %>% 
  filter(Rs_annual < 4000 & Meas_interval < 150 ) %>% 
  filter(Biome %!in% c("", "Alpine")) %>% 
  group_by(Biome, Meas_interval) %>% 
  summarise(Rs_annual = mean(Rs_annual),
            obs = n()) %>% 
  mutate(obs2 = ifelse(obs <= 100, obs, 110)) ->
  sub_interval

lm(sub_interval$Rs_annual ~ sub_interval$Meas_interval * sub_interval$Biome,
   weights = sub_interval$obs) ->
  lm_interval2
summary(lm_interval2)


lm_bio_test <- function(dat, bio) {
  dat %>% 
    filter(Biome == bio) ->
    sub_eco
  # return(sub_eco)
  lm(sub_eco$Rs_annual ~ sub_eco$Meas_interval, weights = sub_eco$obs) %>%
  summary()
}

lm_bio_test(sub_interval, "Arctic")
lm_bio_test(sub_interval, "Boreal")
lm_bio_test(sub_interval, "Mediterranean")
lm_bio_test(sub_interval, "Subtropical")
lm_bio_test(sub_interval, "Temperate")
lm_bio_test(sub_interval, "Tropical")
```


# Data analysis
## test whether collar depth affect Rs_annual
```{r test collar insert depth}
time_depth_test (srdbv5, Collar_height, 50)
ggsave('outputs_collar/Figure1.TestCollarHeight.jpg', width = 6, height = 4)
```

```{r test chamber area}
srdbv5 %>% 
  count(Chamber_area) %>% 
  arrange(Chamber_area)

time_depth_test (srdbv5, Chamber_area, 4000)
ggsave('outputs_collar/Figure2.TestChamberArea.jpg', width = 6, height = 4)
```


```{r test collar insert depth, fig.width=6, fig.height=7}
srdbv5 %>% 
  select(Rs_annual, Collar_depth, Ecosystem_type) %>% 
  filter(Rs_annual < 5000 & Collar_depth < 20 & Ecosystem_type != "") %>% 
  mutate(Ecosystem_group = case_when(
    Ecosystem_type %in% c("Agriculture", "Orchard") ~ "Agriculture",
    Ecosystem_type == "Desert" ~ "Desert",
    Ecosystem_type %in% c("Forest", "Plantation") ~ "Forest",
    Ecosystem_type %in% c("Grassland", "Turfgrass", "Urban", "Urban lawn") ~ "Grassland",
    Ecosystem_type %in% c("Savanna", "Shrubland", "Steppe") ~ "Shrubland",
    Ecosystem_type %in% c("Tundra", "Wetland") ~ "Wetland",
    Ecosystem_type %in% c("Savanna", "Shrubland", "Steppe") ~ "Shrubland",
    TRUE ~ "None")) %>% 
  group_by(Ecosystem_group, Collar_depth) %>% 
  summarise(Rs_annual = mean(Rs_annual),
            obs = n()) %>% 
  mutate(obs2 = ifelse(obs <= 250, obs, 250)) ->
  sub_depth

# with all data
sub_depth %>% 
  filter(Ecosystem_group != "Shrubland" & Collar_depth != 10) %>% 
  ggplot(aes(Collar_depth, Rs_annual)) +
  geom_point(aes(size  = obs2), shape = 16, alpha = 0.5) +
  geom_smooth(data = sub_depth %>% filter(Ecosystem_group == "Desert"), method = "lm", fill = "skyblue") +
  facet_grid(rows = vars(Ecosystem_group), scales = "free") +
  theme_set(theme_bw()) +
  labs(x="Collar depth (cm)", y = expression(R[S]~(g~C~m^{-2}~yr^{-1}))) +
  labs(size="obs (n)")

# with outlier (depth = 10 in shrubland) removed
sub_depth %>% 
  ggplot(aes(Collar_depth, Rs_annual)) +
  geom_point(aes(size  = obs2), shape = 16, alpha = 0.5) +
  geom_smooth(data = sub_depth %>% filter(Ecosystem_group %in% c("Desert", "Shrubland")), method = "lm", fill = "skyblue") +
  facet_grid(rows = vars(Ecosystem_group), scales = "free") +
  theme_set(theme_bw()) +
  labs(x="Collar depth (cm)", y = expression(R[S]~(g~C~m^{-2}~yr^{-1}))) +
  labs(size="obs (n)")  
  
# ggsave('outputs_collar/Figure3.TestCollarDepth.jpg', width = 5, height = 7)

# facet by RC
srdbv5 %>% 
  select(Rs_annual, Collar_depth, RC_annual) %>% 
  filter(Rs_annual < 5000 & Collar_depth < 20 & !is.na(RC_annual) & RC_annual > 0) %>% 
  mutate(RC_group = cut(RC_annual, 6)) %>% 
  group_by(RC_group, Collar_depth) %>% 
  summarise(Rs_annual = mean(Rs_annual),
            obs = n()) %>% 
  mutate(obs2 = ifelse(obs <= 250, obs, 250)) %>% 
  ggplot(aes(Collar_depth, Rs_annual)) +
  geom_point(aes(size  = obs2), shape = 16, alpha = 0.5) +
  facet_grid(rows = vars(RC_group), scales = "free") +
  # geom_smooth(method = "lm", fill = "skyblue") +
  theme_set(theme_bw()) +
  labs(x=expression(Collar~depth~(cm)), y = expression(R[S]~(g~C~m^{-2}~yr^{-1}))) +
  labs(size="obs (n)") 

ggsave('outputs_collar/FigureS3.TestCollarDepth_by_RC.jpg', width = 5, height = 7)
```



```{r test time of day}
srdbv5 %>% 
  select(Rs_annual, Collar_height, Collar_depth, Chamber_area, Time_of_day, Meas_interval, Annual_coverage) %>% 
  filter(!is.na(Rs_annual) & Rs_annual < 5000 & Rs_annual > 0) %>% 
  mutate(Time_day_group = case_when(
    Time_of_day == "0to24" ~ "Full day",
    Time_of_day =="" ~ "Not reported",
    TRUE ~ "Not full day")) ->
  sub_time_grop

sub_time_grop %>% 
  ggplot(aes(Time_day_group, Rs_annual, fill = as.factor(Time_day_group))) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) +
  # geom_jitter(shape = 16, position = position_jitter(0.2), col = "gray") +
  # geom_boxplot(width = 0.1) +
  theme(legend.title = element_blank()) +
  scale_fill_brewer(palette="Set2") +
  xlab(expression(Measurement~coverage)) +
  ylab(expression(Annual~R[S]~(g~C~m^{-2}~yr^{-1}))) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

ggsave('outputs_collar/FigureS2.HourCoverage.jpg', width = 6, height = 4)

sub_time_grop %>% filter(Time_day_group != "Not reported") ->
  sub_time_grop
wilcox.test(Rs_annual ~ Time_day_group, data = sub_time_grop, alternative = "less")

```

```{r test cover hour}
hour_cover_test (srdbv5, hour_cover)
ggsave('outputs_collar/Figure4.TestHoursCovered.jpg', width = 6, height = 4)
```


```{r test measure interval}
meas_interval_test (srdbv5, Meas_interval, 150)
ggsave('outputs_collar/Figure5.TestMeasureInterval.jpg', width = 6, height = 4)
```

```{r test measure interval - facet by biome, fig.height=6, fig.width=6}
# facet by biome
srdbv5 %>% 
  select(Rs_annual, Biome, Meas_interval) %>% 
  filter(Rs_annual < 4000 & Meas_interval < 150 ) %>% 
  filter(Biome %!in% c("", "Alpine")) %>% 
  group_by(Biome, Meas_interval) %>% 
  summarise(Rs_annual = mean(Rs_annual),
            obs = n()) %>% 
  mutate(obs2 = ifelse(obs <= 250, obs, 250)) %>% 
  ggplot(aes(Meas_interval, Rs_annual)) +
  geom_point(aes(size  = obs2), shape = 16, alpha = 0.5) +
  facet_grid(rows = vars(Biome), scales = "free") +
  # geom_smooth(method = "lm", fill = "skyblue") +
  theme_set(theme_bw()) +
  labs(x="Measure interval (day)", y = expression(R[S]~(g~C~m^{-2}~yr^{-1}))) +
  labs(size="obs (n)")

ggsave('outputs_collar/FigureS4.TestMeasureInterval.jpg', width = 6, height = 7)

```

```{r supplemental figures}
# Reported frequency of collar size and sample timing
srdbv5 %>% 
  filter(!is.na(Rs_annual)) %>%
  # Create groups
  mutate(
    Collar_height_group = case_when(
      !is.na(Collar_height) ~ "Yes",
      TRUE ~ "No"),
    Collar_area_group = case_when(
      !is.na(Chamber_area) ~ "Yes",
      TRUE ~ "No"),
    Collar_depth_group = case_when(
      !is.na(Collar_depth) ~ "Yes",
      TRUE ~ "No"),
    Meas_time_group = case_when(
      (Time_of_day != "") ~ "Yes",
      TRUE ~ "No"),
    Meas_interval_group = case_when(
      !is.na(Meas_interval) ~ "Yes",
      TRUE ~ "No")
    ) %>% 
  select(Collar_height_group, Collar_area_group, Collar_depth_group, Meas_time_group, Meas_interval_group) %>% 
  # using gather to pivot table
  gather(key = "Group", value = "YN") %>% 
  # group_by(Group, YN) %>% 
  # summarise(obs = n()) %>% 
  ggplot(aes(Group), stat = "identity") +
  # scale_y_continuous(labels=scales::percent) +
  scale_x_discrete(limits = c("Collar_height_group", "Collar_area_group", "Collar_depth_group", "Meas_time_group", "Meas_interval_group"),
                   labels = c("Collar height", "Collar area", "Collar depth", "Diurnal coverage", "Measure interval")) +
  geom_bar(aes(fill = (YN)), width = 0.75) +
  theme(legend.title = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.title.x = element_blank()) +
  annotate("text", x = c(1:5), y = 500, 
           label = c(expression('46.28'~'%'), expression('74.31'~'%'), 
                     expression('63.32'~'%'), expression('14.18'~'%'), expression('89.37'~'%')),
           parse = TRUE) +
  annotate("text", x = c(1:5), y = 5500, 
           label = c(expression('53.72'~'%'), expression('25.69'~'%'), 
                     expression('36.68'~'%'), expression('85.82'~'%'), expression('10.63'~'%')),
           parse = TRUE) ->
  count_plot

sub_time_grop %>% 
  filter(Time_day_group %!in% "Not reported") %>% 
  count(Time_day_group) %>% 
  ungroup() %>% 
  mutate(percent = round(n/sum(n), 4)) %>% 
  mutate(label = scales::percent(percent)) %>% 
  arrange(desc(Time_day_group)) %>% 
  ggplot() +
  geom_bar(aes(x="", y=percent, fill=Time_day_group), stat="identity", width = 1)+
  coord_polar("y", start=0)+
  theme_void() +
  geom_text(aes(x=c(1, 1.1), y = cumsum(percent) - percent/2, label=label), size = 4) +
  theme(legend.title = element_blank(),
        legend.text=element_text(size=8),
        legend.margin = margin(1, 1, 1, 1),
        legend.box.margin = margin(1, 1, 1, 1)) ->
  pie1


srdbv5 %>% 
  select(Meas_method) %>% 
  filter(Meas_method %!in% "") %>% 
  mutate(Meas_method_group = case_when(
    Meas_method %in% "Alkali absorption" ~ "AA",
    Meas_method %in% "EC" ~ "EC", 
    Meas_method %in% "Gas chromatography" ~ "GC",
    Meas_method %in% "Gradient" ~ "Gradient",
    Meas_method %in% "IRGA" ~ "IRGA",
    TRUE ~ "Other")) %>% 
  count(Meas_method_group) %>% 
  mutate(percent = round(n/sum(n), 4)) %>% 
  mutate(label = paste0(Meas_method_group, "(", scales::percent(percent), ")")) %>% 
  ggplot() +
  geom_bar(aes(x="", y=percent, fill=label), stat="identity", width = 1) +
  coord_polar("y", start=0)+
  theme_void() +
  scale_fill_brewer(palette="Spectral") +
  theme(legend.title = element_blank(),
        legend.text=element_text(size=8),
        legend.margin = margin(1, 1, 1, 1),
        legend.box.margin = margin(1, 1, 1, 1)) ->
  pie2

plot_grid(
  pie1, pie2, 
  labels = c("b", "c")
) ->
  pie

plot_grid(
  count_plot, pie,
  rel_heights = c(1.5, 1),
  nrow = 2,
  labels = c("a",""),
  vjust = c(0.9, 0)
)

ggsave('outputs_collar/FigureS1.MeasureCount.jpg', width = 6, height = 4)

srdbv5 %>% 
  # Create groups
  filter(!is.na(Rs_annual)) %>% 
  mutate(
    Collar_height_group = case_when(
      !is.na(Collar_height) ~ "Yes",
      TRUE ~ "No"),
    Collar_area_group = case_when(
      !is.na(Chamber_area) ~ "Yes",
      TRUE ~ "No"),
    Collar_depth_group = case_when(
      !is.na(Collar_depth) ~ "Yes",
      TRUE ~ "No"),
    Meas_time_group = case_when(
      (Time_of_day != "") ~ "Yes",
      TRUE ~ "No"),
    Meas_interval_group = case_when(
      !is.na(Meas_interval) ~ "Yes",
      TRUE ~ "No")
    ) %>% 
  select(Collar_height_group, Collar_area_group, Collar_depth_group, Meas_time_group, Meas_interval_group) %>% 
  # using gather to pivot table
  gather(key = "Group", value = "YN") %>% 
  group_by(Group, YN) %>%
  summarise(obs = n()) %>% 
  mutate(percet = obs/5741*100)

```



```{r}
srdbv5 %>% 
  select(Chamber_area, Rs_annual) %>% 
  na.omit() %>% 
  group_by(Chamber_area) %>% 
  summarise(obs = n(), percent = n()*100/4266) %>% 
  arrange(desc(percent))
```


