---
title: "SRDBV5-ESSD"
output: html_document
---

```{r preliminaries, message=FALSE, echo=FALSE}
package_list <- c("cowplot","data.table","dplyr","ggplot2", "lubridate", "leaflet"        
                  , "kableExtra","knitr","ggmap","maps","mapdata","tidyr","sp","ggpubr"
                  , "styler", "xlsx", "readxl")

package_new <- package_list[!(package_list %in% installed.packages()[,"Package"])]
if(length(package_new)) install.packages(package_new)

# loading necessary packages
# library("xlsx")
library(readxl)
library(styler)
library(ggplot2)
theme_set(theme_bw())
library(cowplot)
library(tidyr)
library(dplyr)
library(cowplot)
library(data.table)
library(lubridate)
library(kableExtra)
library(knitr)
library(ggpubr)
library(ggmap)
library(maps)
library(mapdata)
library(leaflet)
library(sp)
# Source all needed functions
source('functions.R')

# set data and outputs file direction
DATA_DIR <- 'data'
OUT_DIR <- 'outputs'

# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, 
                      echo = FALSE, warning = FALSE,
                      fig.height = 4, fig.width = 8, cache = FALSE)
```

# Load data
```{r load data}
# load all data necessary for this analysis
srdbv1 <- read_file('srdb-data-v1.csv') 
srdbv2 <- read_file('srdb-data-v2.csv') 
srdbv3 <- read_file('srdb-data-v3.csv') 
srdbv4 <- read_file('srdb-data-v4.csv') 
# srdbv5 <- read_file('srdb-data-v5.csv')
srdbv5 <- read.csv('../srdb/srdb-data.csv')
srdbv5$Site_ID <- as.factor(srdbv5$Site_ID)
IGBP <- read_file('IGBP.txt') %>% 
  left_join(read_file("igbp_mapping.csv"), by = "IGBP2001Pr")
# load global climate data (University of Delaware)
GlobalMATMAP <- read_file('summarized_climate.csv')
srdb_citation <- read_xlsx('SRDB_cited.xlsx')
MGRsD <- read_file('MGRsD.csv')
srdb_study <- read_file('srdb-studies.csv')
```


# ESSD-SRDB-V5 manuscript plots
## srdb citation analysis
```{r Figure 1 - citation}
srdb_citation %>% 
  select(PubYear, Num_citation, Database) %>%  
  ggplot(aes(PubYear, fill = Database)) +
  geom_bar(stat = "count") +
  scale_x_continuous(breaks = seq(2010, 2020, 2)) +
  labs(x=expression(Year), y=expression(Count))

# ggsave('outputs/Figure1.srdb_citation.jpg', width = 8, height = 5)
```


```{r Figure 2 - Sites spatial distribution}
# Base map - word map
worldMap <- map_data(map = "world")
basemap <- ggplot(data = worldMap) + 
  # geom_polygon(aes(x = long, y = lat , fill = region , group = group, alpha = 0.1), color = "white") + 
  geom_polygon(aes(x = long, y = lat, group = group, alpha = 0.1), color = "white", fill = "gray") + 
  coord_fixed(1.3) +
  theme(axis.text.y   = element_text(size = 12),
        axis.text.x   = element_text(size = 12),
        axis.title.y   = element_text(size = 13, margin = margin(t = 0, r = 12, b = 0, l = 0)),
        axis.title.x   = element_text(size = 13, margin = margin(t = 12, r = 0, b = 0, l = 0)),
        panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill = NA, size = 1.25))+
  theme(legend.position = "none")+
  scale_x_continuous(name = "Longitude", breaks = seq(-180, 180, 30),
                     labels = seq(-180, 180, 30)) +
  scale_y_continuous(name = "Latitude", limits = c(-60, 90), breaks = seq(-90, 90, 15),
                     labels = seq(-90,90,15))

# add srdb-v4 sites
# RC sites from SRDB_v4
srdbv4 %>% 
  select(Latitude, Longitude) %>% 
  na.omit() %>% 
  count(Latitude, Longitude) ->
  srdbv4_count

# change count number > 10 to 10, otherwise some circle will be too big
srdbv4_count %>% 
  mutate(n2 = ifelse(n>=10, 10, n)) -> 
  srdbv4_count

sitemap <- basemap +
  geom_point(data = srdbv4_count, aes(x = srdbv4_count$Longitude, y = srdbv4_count$Latitude), 
               color = "black", shape = 1, size = srdbv4_count$n2*0.65, alpha = 0.5)

# add new points from version 5
## added in Chinese
srdb_study %>% select(Study_number, nonEnglish) %>% filter(nonEnglish == "Y") ->
  nonEngStudy
srdbv4 %>% select(Study_number, Country, Latitude, Longitude) %>% 
  filter(Study_number %in% nonEngStudy$Study_number) %>% 
  filter(Country == "China") -> china_papers

china_papers %>% select(Latitude, Longitude) %>% 
  na.omit() %>% 
  count(Latitude, Longitude) %>% 
  mutate(n2 = ifelse(n>=10, 10, n)) ->
  china_papers

## add papers in Russian

## add SRDB-v5 points in other language (mainly in English)
srdbv5 %>% select(Latitude, Longitude, Contributor) %>% 
  filter(Contributor %in% c("JJ", "DP", "JM")) %>% 
  count(Latitude, Longitude) %>% 
  mutate(n2 = ifelse(n>=10, 10, n)) -> srdbv5_add

# plot
# prepare data for legend
cc_legend <- tibble(x = rep(-170, 4),
                    y = c(-10, -25, -40, -55),
                    size = 1)

sitemap <- sitemap +
  geom_point(data = srdbv5_add, aes(x = Longitude, y = Latitude), 
             color = "lightblue", shape = 1, size = srdbv5_add$n2*0.65, alpha = 0.25) +
  geom_point(data = china_papers, aes(x = Longitude, y = Latitude), 
               color = "red", shape = 16, size = china_papers$n2*0.65, alpha = 0.25) +
  # legend
  geom_point(data = cc_legend, aes(x, y, size = size)
             , shape = c(1, 16, 16, 1)
             , color = c("black", "red", "orange", "blue"), alpha = 1) +
  annotate("text", x = -160, y = c(-10, -25, -40, -55)
           , label = c("SRDB-V4", "SRDB-V5 (Chinse)", "SRDB-V5 (Russian)", "SRDB-V5 (other)")
           , size = 3.5, hjust = 0) 
  

print(sitemap)
# ggsave('outputs/Figure2.srdb_sites.jpg', width = 8, height = 5)
```

## Representative analysis
```{r representative box plot, fig.height=6, fig.width=8}
srdb_v_comp(representative(srdbv1, IGBP, GlobalMATMAP)) -> 
  v1_plot

srdb_v_comp(representative(srdbv2, IGBP, GlobalMATMAP)) -> 
  v2_plot

srdb_v_comp(representative(srdbv3, IGBP, GlobalMATMAP)) -> 
  v3_plot

srdb_v_comp(representative(srdbv4, IGBP, GlobalMATMAP)) -> 
  v4_plot

srdb_v_comp(representative(srdbv5, IGBP, GlobalMATMAP)) -> 
  v5_plot

# use cowplot put them together
plot_grid(v1_plot, v2_plot, v3_plot, v4_plot, v5_plot
          , labels = c("v1", "v2", "v3", "v4")
          , ncol = 2)

```



## Representative analysis - density plot
```{r Figure 3 and 4 - representative density plot, fig.height=8, fig.width=8}

# prepare data
bind_rows(representative(srdbv1, IGBP, GlobalMATMAP) %>% mutate(vs = "SRDB-V1"),
          representative(srdbv2, IGBP, GlobalMATMAP) %>% mutate(vs = "SRDB-V2"),
          representative(srdbv3, IGBP, GlobalMATMAP) %>% mutate(vs = "SRDB-V3"),
          representative(srdbv4, IGBP, GlobalMATMAP) %>% mutate(vs = "SRDB-V4"),
          representative(srdbv5, IGBP, GlobalMATMAP) %>% mutate(vs = "SRDB-V5")
          ) ->
  srdb_comb
  
# plot MAT density comparison
srdb_comb %>% 
  filter(!is.na(Ecosystem) & !is.na(MAT)) %>% 
  ggplot(aes(x = MAT, fill = factor(Source))) +
    facet_grid(rows = vars(Ecosystem),
               cols = vars(vs),
               scales = "free") +
  theme(legend.position = "none"
        # , axis.title.x=element_blank()
        , axis.text.x = element_text(angle = 25, hjust = 1)) +
  # geom_violin(draw_quantiles = c(0.5))
  geom_density(alpha = 0.5) +
  labs(x=expression(MAT~"("~degree~C~")"), y=expression(Density))

# ggsave('outputs/Figure3.MAT.jpg', width = 8, height = 8)

# plot MAP density comparison
srdb_comb %>% 
  filter(!is.na(Ecosystem) & !is.na(MAP)) %>% 
  filter(MAP <= 4000) %>% 
  ggplot(aes(x = MAP, fill = factor(Source))) +
    facet_grid(rows = vars(Ecosystem),
               cols = vars(vs),
               scales = "free") +
  theme(legend.position = "none"
        # , axis.title.x=element_blank()
        , axis.text.x = element_text(angle = 25, hjust = 1)) +
  # geom_violin(draw_quantiles = c(0.5))
  geom_density(alpha = 0.5) +
  labs(x=expression(MAP~"(mm)"), y=expression(Density))

# ggsave('outputs/Figure4.MAP.jpg', width = 8, height = 8)
```


# Data quality check 
## Check the duplicate Site_ID in srdb
```{r check 1 - unique Site-ID}
# Idealy, every row in srdbv5 should have a unique ID (which is the combine of study_number, measure_year, and site_ID)

srdbv5 %>% 
  select(Study_number, Study_midyear, Site_ID) %>% 
  count(Study_number, Study_midyear, Site_ID, sort = TRUE) %>% 
  filter (n >= 2) %>% 
  arrange(Study_number)
```


## Check Site_ID
```{r check 2 - check lower case character in Site_ID}
# check there are no lower case character in Site_ID column for bother srdb and MGRsD
# this code does not work, why?
MGRsD %>% 
  select (Study_number, Site_ID) %>% 
  filter (MGRsD$Site_ID %in% letters )

srdbv5 %>% 
  select (Study_number, Site_ID) %>%
  filter (Site_ID %in% letters )
```


## Find out those studies in MGRsD but not in SRDB
```{r check 3 - studies in MGRsD but not in SRDB}
# find out studies not in srdb, need to add the information
mgrsd_notin_srdb(srdbv5, MGRsD) 
```

## Find out those studies in SRDB but not in MGRsD
```{r check 4 - studies in SRDB but not in MGRsD, results = 'hide' }
srdb_notin_mgrsd(srdbv5, MGRsD) %>% 
  arrange(Study_number) %>% 
  unique()
```



## Check all countries and whether they have currect acronym
```{r check 5 - contries duplication check}
srdbv5 %>% 
  mutate(Country_acronym = substr(Site_ID, 1,2)) %>% 
  select (Country) %>% 
  unique() %>% 
  count(Country, sort = TRUE)
```

## Check country code
```{r check 5 - contry code duplication check}
MGRsD %>% 
  mutate(Country_acronym = substr(Site_ID, 1, 2)) %>% 
  select (Country, Country_acronym) %>% 
  unique() %>% 
  count(Country, Country_acronym, sort = TRUE)
```


## Find out those Site_ID in MGRsD but not in SRDB 
```{r check 6 - Site-ID in MGRsD but not in SRDB}
site_ID_check(srdbv5) %>% 
  filter(is.na(srdb_ID)) %>% 
  filter(Study_number %!in% mgrsd_notin_srdb(srdbv5, MGRsD)[,1]) %>% 
  arrange (Study_number)
```

## For those have more than 11 months Rs from MGRsD, comparing that with SRDB
```{r check 7.1 - Rs_annual agreement between MGRsD and SRDB}
# prepare data
srdb_vs_mgrsd <- srdb_vs_mgrsd()

# Regression between Rs_annual from SRDB and Rs_annual from MGRsD
srdb_vs_mgrsd %>% 
  ggplot(aes(RS_annual_mgrsd, RS_annual_srdb)) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  geom_abline(slope = 1, intercept = 0, col = "red", linetype = "dashed", size = 1.5) +
  labs(x=expression(Annual~R[S]~"(MGRsD)"), y=expression(Annual~R[S]~"(SRDB)"))

ggsave('outputs/Figure5.SRDB-MGRsD.jpg', width = 6, height = 4)

lm(RS_annual_srdb ~ RS_annual_mgrsd, data = srdb_vs_mgrsd) %>% summary()
```


## Find out sites with big Rs_annual difference between SRDB and MGRsD
```{r check 7.2 - Rs_annual agreement between MGRsD and SRDB}
srdb_vs_mgrsd %>% 
  mutate(ratio = RS_annual_mgrsd / RS_annual_srdb) %>% 
  arrange(ratio)
```


## Check sites by country
```{r check 8 - sites by country}
# Find out those countries with most sites
srdbv5 %>% count(Country, sort = TRUE)

# plot by country
lot_long_check(srdbv5, "USA")
# srdbv5 %>% filter(Longitude > 0) %>% select(Study_number) %>% unique()
lot_long_check(srdbv5, "China")
srdbv5 %>% filter(Latitude < 22 & Country == "China") %>% 
  select(Study_number, Country, Region, Latitude, Longitude) %>% 
  arrange(Latitude)

lot_long_check(srdbv5, "Canada")
lot_long_check(srdbv5, "Finland")
lot_long_check(srdbv5, "Japan")
lot_long_check(srdbv5, "Germany")
```


## check manipulation etc.
```{r check 9 - check meta data}
srdbv5 %>% 
  count(Manipulation, sort = TRUE) 
srdbv5 %>% 
  select(Manipulation) %>% 
  unique() %>% 
  arrange(Manipulation) -> 
  manipltion
manipltion 

writ_file(manipltion, 'manipulation.csv')

srdbv5 %>% 
  count(Meas_method, sort = TRUE) 
srdbv5 %>% 
  count(Partition_method, sort = TRUE) 

# questions
srdbv5 %>% 
  count(Biome, sort = TRUE) 
srdbv5 %>% 
  count(Ecosystem_state, sort = TRUE) 
srdbv5 %>% 
  count(Leaf_habit, sort = TRUE) 
srdbv5 %>% 
  count(Stage, sort = TRUE) 
```






